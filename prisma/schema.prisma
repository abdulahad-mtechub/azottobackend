generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////
// ENUMS
//////////////////////

enum UserRole {
  ADMIN
  DEALER
  SELLER
  CUSTOMER
}

enum AlertAction {
  CREATE
  UPDATE
  DELETE
  EXPORT
  IMPORT
  LOGIN
  LOGOUT
  EDIT
  REQUEST
  CHANGE_STATUS
  CONTACTED
  RENEW
  MAINTENANCE_MODE
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  RESTORE
}

enum EntityType {
  USER
  WALLET
  VIN_PASSPORT
  INVOICE
  PART
  GAS_SETTLEMENT
  BLOCKCHAIN_TX
  ONCHAIN_PROOF
  DOCUMENT
}


enum TxStatus {
  PENDING
  VERIFIED
  CONFIRMED
  FAILED
}

enum FileType {
  INVOICE
  IMAGE
  PDF
  OTHER
}

enum FileState {
  UPLOADED
  PROCESSING
  VERIFIED
  REJECTED
}

enum ColorStatus {
  GREEN
  YELLOW
  LIGHT_ORANGE
  DARK_ORANGE
  RED
}

//////////////////////
// USER
//////////////////////

model User {
  id            String   @id @default(uuid())
  name          String?
  email         String?   @unique
  password      String?
  role          UserRole

  walletAddress String?   @unique
  signature     String?   // do NOT keep unique if this is login-based

  wallet        AztoWallet?
  auditLogs     AuditLog[]
  aiQuotas      AIQuota[]
  aiDecisions   AIDecision[]
  chainTxs      BlockchainTransaction[]
  alerts        Alert[]
  documents     Document[]

  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime?
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?
  isDeleted Boolean  @default(false)

  @@index([walletAddress])
  @@index([isDeleted])
}

//////////////////////
// WALLET 
//////////////////////

model AztoWallet {
  id      String  @id @default(uuid())
  balance Decimal @default(0) @db.Decimal(18, 8)

  userId  String  @unique
  user    User    @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime?
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?
  isDeleted Boolean  @default(false)
}

//////////////////////
// VIN PASSPORT
//////////////////////

model VinPassport {
  id             String @id @default(uuid())
  vin            String @unique

  invoices       Invoice[]
  gasSettlements GasSettlement[]
  auditLogs      AuditLog[]
  onChainProofs  OnChainProof[]
  documents      Document[]
  conditionMatrices   ConditionMatrix[]   
  mechanicalHealths   MechanicalHealth[]  

  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime?
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?
  isDeleted Boolean  @default(false)

  @@index([vin])
  @@index([isDeleted])
}

//////////////////////
// GAS SETTLEMENT Remove
//////////////////////

model GasSettlement {
  id            String  @id @default(uuid())
  amount        Decimal @db.Decimal(18, 8)

  vinPassportId String
  vinPassport   VinPassport @relation(fields: [vinPassportId], references: [id])

  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime?
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?
  isDeleted Boolean  @default(false)

  @@index([vinPassportId])
}

//////////////////////
// INVOICE
//////////////////////

model Invoice {
  id            String @id @default(uuid())
  number        String @unique
  status        TxStatus

  vinPassportId String?
  vinPassport   VinPassport? @relation(fields: [vinPassportId], references: [id])
  documents Document[]

  parts         NormalizedPart[]
  auditLogs     AuditLog[]
  onChainProofs OnChainProof[]

  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime?
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?
  isDeleted Boolean  @default(false)

  @@index([vinPassportId])
  @@index([isDeleted])
}

//////////////////////
// NORMALIZED PART
//////////////////////

model NormalizedPart {
  id        String  @id @default(uuid())
  name      String
  price     Decimal @db.Decimal(18, 2)

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime?
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?
  isDeleted Boolean  @default(false)

  @@index([invoiceId])
}

//////////////////////
// AI / SYSTEM
//////////////////////

model AIDecision {
  id           String @id @default(uuid())
  entityType   EntityType
  entityId     String

  model        String
  promptHash   String
  responseHash String
  decision     String
  confidence   Float?
  metadata     Json?

  userId       String?
  user         User? @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
}

model AIQuota {
  id                String @id @default(uuid())
  userId            String
  invoicesProcessed Int    @default(0)
  rejectedCount     Int    @default(0)
  periodStart       DateTime
  periodEnd         DateTime

  user User @relation(fields: [userId], references: [id])
}

model ConditionMatrix {
  id            String @id @default(uuid())
  vinPassportId String?
  vinPassport   VinPassport? @relation(fields: [vinPassportId], references: [id])

  version       String
  rulesHash     String
  effectiveFrom DateTime
  isActive      Boolean @default(false)

  auditLogs AuditLog[] @relation("ConditionMatrixAuditLogs")  // remove references here

  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime?
  updatedBy String?
}


model SystemState {
  id        String @id @default(uuid())
  key       String @unique
  value     String

  updatedAt DateTime @updatedAt
  updatedBy String?
}

//////////////////////
// BLOCKCHAIN
//////////////////////

model BlockchainTransaction {
  id            String   @id @default(uuid())
  chain         String
  contract      String
  txHash        String   @unique
  blockNumber   BigInt?
  eventName     String?
  status        TxStatus

  entityType    EntityType
  entityId      String

  payload       Json
  confirmations Int      @default(0)

  userId      String?
  user        User? @relation(fields: [userId], references: [id])

  auditLogs     AuditLog[] 

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([entityType, entityId])
}

model OnChainProof { //remove
  id            String @id @default(uuid())
  entityType    EntityType
  entityId      String

  hash          String
  algorithm     String
  chain         String
  contract      String
  txHash        String

  invoiceId     String?
  invoice       Invoice?     @relation(fields: [invoiceId], references: [id])

  vinPassportId String?
  vinPassport   VinPassport? @relation(fields: [vinPassportId], references: [id])

  createdAt DateTime @default(now())
}

model ChainCursor { //remove
  id        String @id @default(uuid())
  chain     String
  contract  String
  lastBlock BigInt

  updatedAt DateTime @updatedAt
}

model Document {
  id           String      @id @default(uuid())
  fileName     String
  fileUrl      String
  fileType     FileType
  state        FileState   @default(UPLOADED)
  checksum     String

  vinPassportId String?    
  vinPassport   VinPassport? @relation(fields: [vinPassportId], references: [id])

  invoiceId    String?     
  invoice      Invoice?     @relation(fields: [invoiceId], references: [id])

  uploadedById String?     
  uploadedBy   User?        @relation(fields: [uploadedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime?
  deletedAt DateTime?
  isDeleted Boolean  @default(false)
  deletedBy String?

  auditLogs AuditLog[] @relation("DocumentAuditLogs") 

  @@index([vinPassportId])
  @@index([invoiceId])
  @@index([uploadedById])
}

model MechanicalHealth {
  id            String       @id @default(uuid())
  vinPassportId String       @unique
  vinPassport   VinPassport  @relation(fields: [vinPassportId], references: [id])
  
  partsMaintained Json?
  lastUpdate     DateTime?
  greenLight     Boolean      @default(false)
  
  auditLogs AuditLog[] @relation("MechanicalHealthAuditLogs")  // remove references

  createdAt DateTime @default(now())
  updatedAt DateTime?
  deletedAt DateTime?
  isDeleted Boolean @default(false)
}


//////////////////////
// AUDIT LOG
//////////////////////

model AuditLog {
  id         String      @id @default(uuid())
  action     AuditAction
  entityType EntityType
  entityId   String

  oldValue   Json?
  newValue   Json?

  userId        String?
  user          User?        @relation(fields: [userId], references: [id])

  invoiceId     String?
  invoice       Invoice?     @relation(fields: [invoiceId], references: [id])

  vinPassportId String?
  vinPassport   VinPassport? @relation(fields: [vinPassportId], references: [id])

  chainTxId     String?
  chainTx       BlockchainTransaction? @relation(fields: [chainTxId], references: [id])

  documentId String?    // foreign key
  document   Document?  @relation("DocumentAuditLogs", fields: [documentId], references: [id])

  conditionMatrixId String?
  conditionMatrix   ConditionMatrix? @relation("ConditionMatrixAuditLogs", fields: [conditionMatrixId], references: [id])

  mechanicalHealthId String?
  mechanicalHealth   MechanicalHealth? @relation("MechanicalHealthAuditLogs", fields: [mechanicalHealthId], references: [id])


  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime?
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?
  isDeleted Boolean  @default(false)

  @@index([entityType, entityId])
  @@index([userId])
}

//////////////////////
// ALERTS
//////////////////////

model Alert {
  id         String      @id @default(uuid())
  userName   String
  userRole   UserRole
  action     AlertAction
  activity   String
  businessId String?

  isRead     Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  deletedBy String?
  isDeleted Boolean  @default(false)

  userId     String?
  user       User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
}
