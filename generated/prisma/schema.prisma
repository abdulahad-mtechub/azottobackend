generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

//////////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////////

enum BusinessType {
  SPA
  CLINIC
  BARBER
  GENERAL
}

enum ContactStatus {
  PENDING
  CONTACTED
}

enum DemoStatus {
  PENDING
  CONTACTED
}

enum DiscountGroup {
  OLD
  NEW
}

enum DiscountType {
  FIXED
  PERCENTAGE
}

enum SubscriptionType {
  BASIC
  STANDARD
  PRO
  ENTERPRISE
}

enum SubscriptionValidity {
  MONTHLY
  YEARLY
}

enum UserRole {
  SUPER_ADMIN
  // CEO
  // ADMIN
  TECHNICAL_ADMIN
  DEMO_ADMIN
  STAFF_MEMBER
  SUBSCRIBER
  BRANCH_MANAGER
  SERVICE_PROVIDER
  RECEPTIONIST
  CONSUMER
  TABLET
}

enum WeekDay {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum ScheduleOwnerType {
  BUSINESS
  BRANCH
  STAFF
}

enum ScheduleInheritanceMode {
  INHERIT
  CUSTOM
}

enum NotificationType {
  SCHEDULE_CHANGE_BUSINESS
  SCHEDULE_CHANGE_BRANCH
  SCHEDULE_CHANGE_OVERRIDE
  BRANCH_ASSIGNMENT
  GENERAL
}

enum BusinessStatus {
  ACTIVE
  INACTIVE
}

enum AdTargetType {
  NEW
  OLD
  BOTH
}

enum AdStatus {
  PENDING
  EXPIRED
}

enum StepType {
  TEXT
  TEXT_WITH_OPTIONS
  BUTTONS
  CONFIRMATION
  INPUT
  FORM
  INSERT_FLOW
}

enum DynamicSource {
  NONE
  BRANCHES
  SERVICES
  PROVIDERS
  APPOINTMENT
}

enum VacationType {
  SICK
  PERSONAL
  MATERNITY
  UNPAID
}

enum VacationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LEAVE
}

enum AppointmentStatus {
  SCHEDULED
  PENDING
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum AppointmentBookingType {
  BY_TIME
  BY_SERVICE_PROVIDER
}

enum StaffStatus {
  ONLINE
  OFFLINE
}

//////////////////////////////////////////////////////////
// MODELS
//////////////////////////////////////////////////////////

model User {
  id                 String   @id @default(uuid())
  firstName          String   @default("")
  lastName           String   @default("")
  email              String   @unique
  password           String
  phone              String   @default("")
  role               UserRole @default(CONSUMER)
  branchId           String?
  subscriberId       String?
  imageUrl           String?
  isActive           Boolean  @default(true)
  availability       Json?
  usesBranchSchedule Boolean  @default(true)
  managerId          String?
  x                  String?
  instagram          String?
  fb                 String?
  whatsapp           String?
  language           String?
  isLoggedIn         Boolean  @default(false)

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
  createdBy String?
  updatedBy String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?

  subscriber              User?                    @relation("SubscriberOwner", fields: [subscriberId], references: [id])
  subscriberMembers       User[]                   @relation("SubscriberOwner")
  branch                  Branch?                  @relation("UserBranch", fields: [branchId], references: [id])
  services                UserOnService[]          @relation("UserProviders")
  appointmentsAsConsumer  Appointment[]            @relation("ConsumerAppointments")
  appointmentsAsProvider  Appointment[]            @relation("ServiceProviderAppointments")
  businesses              Business[]               @relation("UserBusinesses")
  ownedBranches           Branch[]                 @relation("UserSubscriberBranches")
  subscriberSubscriptions SubscriberSubscription[] @relation("UserSubscriberSubscriptions")
  subscription            Subscription?            @relation("UserSubscription")
  assignedWhatsappAds     WhatsappAd[]             @relation("WhatsappAdAssignedCustomers")
  scheduleHours           ScheduleHour[]           @relation("StaffScheduleHours")
  sessions                Session[]                @relation("UserSessions")
  attendanceRecords       Attendance[]             @relation("StaffAttendance")
  vacations               Vacation[]               @relation("StaffVacations")

  staffMembers User[]           @relation("StaffToManager")
  manager      User?            @relation("StaffToManager", fields: [managerId], references: [id])
  statusLogs   StaffStatusLog[] @relation("UserStatusLogs")
}

//////////////////////////////////////////////////////////
// MAINTENANCE SETTING
//////////////////////////////////////////////////////////

model MaintenanceSetting {
  id            String    @id @default(uuid())
  isEnabled     Boolean   @default(false)
  updatedById   String?
  updatedByName String?
  updatedByRole UserRole?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?
  updatedBy String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?
}

model Subscription {
  id                   String           @id @default(uuid())
  type                 SubscriptionType
  description          String
  price                Float
  noOfBranches         Int
  noOfAdmins           Int
  noOfStaffManagers    Int
  noOfServiceProviders Int
  noOfReceptionists    Int
  whatsappBot          Boolean
  manualReminder       Boolean
  automatedReminder    Boolean
  googleReviewLink     Boolean
  promotions           Boolean
  selfServiceTablet    Boolean
  basicDashboard       Boolean
  fullAccessDashboard  Boolean
  subscriberId         String?          @unique
  subscriber           User?            @relation("UserSubscription", fields: [subscriberId], references: [id])

  subscriberSubscriptions SubscriberSubscription[]
  businesses              Business[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?
  updatedBy String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?
}

model SubscriberSubscription {
  id             String               @id @default(uuid())
  subscriberId   String
  subscriptionId String
  type           SubscriptionType
  validity       SubscriptionValidity
  price          Float
  features       Json
  startDate      DateTime
  businessId     String?
  endDate        DateTime?
  isActive       Boolean              @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?
  updatedBy String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?

  business     Business?                 @relation(fields: [businessId], references: [id])
  subscriber   User                      @relation("UserSubscriberSubscriptions", fields: [subscriberId], references: [id])
  subscription Subscription              @relation(fields: [subscriptionId], references: [id])
  appointments Appointment[]
  discountLogs SubscriptionDiscountLog[]
}

//////////////////////////////////////////////////////////
// DISCOUNT
//////////////////////////////////////////////////////////

model Discount {
  id                String           @id @default(uuid())
  code              String           @unique
  group             DiscountGroup
  packageType       SubscriptionType
  discountType      DiscountType
  value             Float
  usageLimit        Int?
  usageCount        Int              @default(0)
  startDate         DateTime
  expiryDate        DateTime
  isManuallyExpired Boolean          @default(false)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?
  updatedBy String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?

  businesses               Business[]
  appointments             Appointment[]
  subscriptionDiscountLogs SubscriptionDiscountLog[]
}

model SubscriptionDiscountLog {
  id String @id @default(uuid())

  subscriberSubscriptionId String
  discountId               String

  // snapshot values (IMPORTANT)
  discountCode     String
  discountType     DiscountType
  discountValue    Float
  discountedAmount Float
  originalPrice    Float
  finalPrice       Float

  appliedAt DateTime @default(now())

  // relations
  subscriberSubscription SubscriberSubscription @relation(fields: [subscriberSubscriptionId], references: [id])

  discount Discount @relation(fields: [discountId], references: [id])

  createdBy String?

  @@index([subscriberSubscriptionId])
  @@index([discountId])
}

//////////////////////////////////////////////////////////
// BUSINESS
//////////////////////////////////////////////////////////

model Business {
  id                   String                @id @default(uuid())
  businessId           Int                   @unique
  name                 String
  image                String?
  websiteLink          String?
  phoneNumber          String?
  businessType         BusinessType
  subscriptionId       String?
  subscriptionType     SubscriptionType?
  subscriptionPrice    Float?
  subscriptionValidity SubscriptionValidity?
  discountCodeId       String?
  subscriberId         String?
  status               BusinessStatus        @default(ACTIVE)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?
  updatedBy String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?

  flows                   Flow[]
  whatsappNumbers         WhatsAppNumber[]
  subscriber              User?                    @relation("UserBusinesses", fields: [subscriberId], references: [id])
  discountCode            Discount?                @relation(fields: [discountCodeId], references: [id])
  branches                Branch[]
  subscription            Subscription?            @relation(fields: [subscriptionId], references: [id])
  subscriberSubscriptions SubscriberSubscription[]
  scheduleHours           ScheduleHour[]           @relation("BusinessScheduleHours")
}

//////////////////////////////////////////////////////////
// BRANCH / SERVICE / APPOINTMENT
//////////////////////////////////////////////////////////

model Branch {
  id           String  @id @default(uuid())
  name         String
  subscriberId String
  businessId   String?
  location     String?
  phone        String?
  status       Boolean @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?
  updatedBy String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?

  subscriber      User            @relation("UserSubscriberBranches", fields: [subscriberId], references: [id])
  business        Business?       @relation(fields: [businessId], references: [id])
  users           User[]          @relation("UserBranch")
  serviceBranches ServiceBranch[] @relation("BranchServices")
  appointments    Appointment[]
  promotions      Promotion[]     @relation("PromotionBranches")
  tabletAccounts  TabletAccount[]
  whatsappAds     WhatsappAd[]
  scheduleHours   ScheduleHour[]  @relation("BranchScheduleHours")
}

//////////////////////////////////////////////////////////
// UNIFIED SCHEDULE SYSTEM
//////////////////////////////////////////////////////////

model ScheduleHour {
  id              String                  @id @default(uuid())
  ownerType       ScheduleOwnerType
  ownerId         String
  dayOfWeek       WeekDay
  openTime        String
  closeTime       String
  isClosed        Boolean                 @default(false)
  inheritanceMode ScheduleInheritanceMode @default(INHERIT)

  // Foreign Keys (must exist for relations)
  staffId    String?
  businessId String?
  branchId   String?

  // Metadata
  lastModifiedBy String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  createdBy      String?
  updatedBy      String?
  isDeleted      Boolean   @default(false)
  deletedAt      DateTime?
  deletedBy      String?

  // Relations
  staff    User?     @relation("StaffScheduleHours", fields: [staffId], references: [id])
  business Business? @relation("BusinessScheduleHours", fields: [businessId], references: [id])
  branch   Branch?   @relation("BranchScheduleHours", fields: [branchId], references: [id])

  @@unique([ownerType, ownerId, dayOfWeek])
  @@index([ownerId, ownerType])
  @@index([staffId])
  @@index([businessId])
  @@index([branchId])
}

model StaffStatusLog {
  id        String      @id @default(uuid())
  userId    String
  status    StaffStatus // ONLINE or OFFLINE
  timestamp DateTime    @default(now())

  // Relations
  user User @relation("UserStatusLogs", fields: [userId], references: [id])

  @@index([userId])
}

model Attendance {
  id      String           @id @default(uuid())
  staffId String
  date    DateTime
  status  AttendanceStatus
  notes   String?

  staff User @relation("StaffAttendance", fields: [staffId], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?
  updatedBy String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?
}

model Vacation {
  id        String         @id @default(uuid())
  staffId   String
  startDate DateTime
  endDate   DateTime
  reason    String?
  status    VacationStatus

  staff User @relation("StaffVacations", fields: [staffId], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?
  updatedBy String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?
}

// Notification model removed; using Alert instead

//////////////////////////////////////////////////////////
// SERVICE / APPOINTMENT  /  REVIEW
//////////////////////////////////////////////////////////

model Service {
  id         String  @id @default(uuid())
  name       String
  providerId String?
  duration   Int
  price      Float
  bufferTime Int
  status     Boolean @default(true)
  frequency  Int?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?
  updatedBy String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?

  providers    UserOnService[] @relation("ServiceProviders")
  branches     ServiceBranch[] @relation("ServiceBranches")
  appointments Appointment[]
  whatsappAds  WhatsappAd[]
}

model UserOnService {
  id         String @id @default(uuid())
  serviceId  String
  providerId String

  service  Service @relation("ServiceProviders", fields: [serviceId], references: [id])
  provider User    @relation("UserProviders", fields: [providerId], references: [id])
}

model ServiceBranch {
  id        String @id @default(uuid())
  serviceId String
  branchId  String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?
  updatedBy String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?

  service Service @relation("ServiceBranches", fields: [serviceId], references: [id], onDelete: Cascade)
  branch  Branch  @relation("BranchServices", fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([serviceId, branchId])
}

model Appointment {
  id                       String                  @id @default(uuid())
  serviceId                String
  consumerId               String
  branchId                 String
  serviceProviderId        String?
  appointmentTime          DateTime
  appointmentDate          DateTime?
  appointmentTimeSlot      String?
  reminderMinutesBefore    Int?
  discountId               String?
  note                     String?
  status                   AppointmentStatus       @default(SCHEDULED)
  bookingType              AppointmentBookingType? @default(BY_TIME)
  review                   String?
  rating                   Int?
  isManual                 Boolean                 @default(false)
  price                    Int?
  subscriberSubscriptionId String?
  promotionId              String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?
  updatedBy String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?

  // add relation of Discount
  promotion              Promotion?              @relation(fields: [promotionId], references: [id])
  subscriberSubscription SubscriberSubscription? @relation(fields: [subscriberSubscriptionId], references: [id])
  discount               Discount?               @relation(fields: [discountId], references: [id])
  service                Service                 @relation(fields: [serviceId], references: [id])
  consumer               User                    @relation("ConsumerAppointments", fields: [consumerId], references: [id])
  serviceProvider        User?                   @relation("ServiceProviderAppointments", fields: [serviceProviderId], references: [id])
  branch                 Branch                  @relation(fields: [branchId], references: [id])

  @@index([serviceProviderId])
  @@index([promotionId])
}

model Promotion {
  id         String       @id @default(cuid())
  name       String // "Promo Name"
  type       DiscountType // "Promo Type" (Enum)
  value      Float
  limit      Int?
  status     Boolean      @default(true)
  branches   Branch[]     @relation("PromotionBranches")
  startDate  DateTime // "Start Date"
  expiryDate DateTime // "Expiry Date"
  imageUrl   String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?
  updatedBy String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?

  appointments Appointment[]
}

model TabletAccount {
  id             String    @id @default(cuid())
  username       String    @unique
  password       String
  branchId       String
  loginLink      String?   @default("")
  loginToken     String
  branch         Branch    @relation(fields: [branchId], references: [id])
  isActive       Boolean   @default(true)
  isLoggedIn     Boolean   @default(false)
  lastActivityAt DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?
  updatedBy String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?
}

model WhatsappAd {
  id           String       @id @default(cuid())
  name         String
  description  String?      @db.Text
  imageUrl     String?
  targetDate   DateTime
  customerType AdTargetType
  branchId     String
  serviceId    String?
  status       AdStatus     @default(PENDING)

  branch            Branch   @relation(fields: [branchId], references: [id])
  service           Service? @relation(fields: [serviceId], references: [id])
  assignedCustomers User[]   @relation("WhatsappAdAssignedCustomers")

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?
  updatedBy String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?
}

//////////////////////////////////////////////////////////
// WHATSAPP SETTING
//////////////////////////////////////////////////////////

model WhatsAppNumber {
  id            String  @id @default(uuid())
  businessId    String
  phoneNumber   String // human-readable e.g. +92300xxxxxxx
  phoneNumberId String? // Meta phone_number_id
  wabaId        String? // WABA id
  accessToken   String? // long-lived token (store encrypted in prod)
  isVerified    Boolean @default(false)
  defaultFlowId String? // which flow starts when message arrives on this number
  otp           Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isDeleted Boolean  @default(false)

  business    Business @relation(fields: [businessId], references: [id])
  defaultFlow Flow?    @relation("FlowToWhatsAppNumber", fields: [defaultFlowId], references: [id])
}

// The flow created by admin (Reservation Flow)
model Flow {
  id         String  @id @default(uuid())
  name       String
  isActive   Boolean @default(true)
  businessId String? // <--- tenant

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String
  updatedBy String?
  DeletedBy String?
  DeletedAt DateTime?
  isDeleted Boolean   @default(false)

  business        Business?        @relation(fields: [businessId], references: [id])
  steps           Step[]
  sessions        Session[] // <--- IMPORTANT BACK RELATION
  whatsappNumbers WhatsAppNumber[] @relation("FlowToWhatsAppNumber")
}

// An individual step in the flow
model Step {
  id            String        @id @default(uuid())
  flowId        String
  order         Int // order in the flow like 1,2, 3
  type          StepType
  message       String?
  dynamicSource DynamicSource @default(NONE) // list will come dynamically from database

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String
  updatedBy String?
  DeletedBy String?
  DeletedAt DateTime?
  isDeleted Boolean   @default(false)

  flow            Flow         @relation(fields: [flowId], references: [id])
  options         StepOption[]
  sessions        Session[]    @relation("CurrentStepSessions") // <--- back relation
  logs            Log[]
  nextStepOptions StepOption[] @relation("NextStepRelation")
}

// Step options for TEXT_WITH_OPTIONS
model StepOption {
  id         String  @id @default(uuid())
  stepId     String
  label      String
  value      String
  nextStepId String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String
  updatedBy String?
  DeletedBy String?
  DeletedAt DateTime?
  isDeleted Boolean   @default(false)

  step     Step  @relation(fields: [stepId], references: [id])
  nextStep Step? @relation("NextStepRelation", fields: [nextStepId], references: [id])
}

// -------------------- USER SESSION --------------------

// A conversation session with a customer
model Session {
  id            String  @id @default(uuid())
  userId        String
  flowId        String
  currentStepId String?

  isCompleted Boolean @default(false)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String
  updatedBy String?
  DeletedBy String?
  DeletedAt DateTime?
  isDeleted Boolean   @default(false)

  flow Flow @relation(fields: [flowId], references: [id])
  user User @relation("UserSessions", fields: [userId], references: [id])

  currentStep Step? @relation("CurrentStepSessions", fields: [currentStepId], references: [id])

  logs Log[]
}

// -------------------- LOGS --------------------

// Each message between admin automation and the user
model Log {
  id        String  @id @default(uuid())
  sessionId String
  stepId    String?
  message   String
  direction String // incoming / outgoing (or create enum if needed)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?
  updatedBy String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?

  session Session @relation(fields: [sessionId], references: [id])
  step    Step?   @relation(fields: [stepId], references: [id])
}

//////////////////////////////////////////////////////////
// CONTACT US
//////////////////////////////////////////////////////////

model ContactUs {
  id           String        @id @default(uuid())
  customerName String
  email        String
  phone        String?
  businessType BusinessType
  message      String
  note         String?
  status       ContactStatus @default(PENDING)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?
  updatedBy String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?
}

model BookDemo {
  id           String       @id @default(uuid())
  name         String
  email        String
  phone        String?
  businessType BusinessType
  message      String
  note         String?
  status       DemoStatus   @default(PENDING)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?
  updatedBy String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?
}

model FAQ {
  id       String @id @default(uuid())
  question String
  answer   String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?
  updatedBy String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?
}

model TermsCondition {
  id      String @id @default(uuid())
  content String @db.Text

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?
  updatedBy String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?
}

model PrivacyPolicy {
  id      String @id @default(uuid())
  content String @db.Text

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?
  updatedBy String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?
}

enum AlertAction {
  CREATE
  UPDATE
  DELETE
  EXPORT
  IMPORT
  LOGIN
  LOGOUT
  EDIT
  REQUEST
  CHANGE_STATUS
  CONTACTED
  RENEW
  MAINTENANCE_MODE
}

model Alert {
  id        String      @id @default(uuid())
  userName  String
  userRole  UserRole
  action    AlertAction
  activity  String
  isRead    Boolean     @default(false)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  userId    String?
}
