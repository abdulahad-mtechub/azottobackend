generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////
// ENUMS
//////////////////////

enum UserRole {
  ADMIN
  DEALER
  SELLER
  CUSTOMER
}

enum AlertAction {
  CREATE
  UPDATE
  DELETE
  EXPORT
  IMPORT
  LOGIN
  LOGOUT
  EDIT
  REQUEST
  CHANGE_STATUS
  CONTACTED
  RENEW
  MAINTENANCE_MODE
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  RESTORE
}

enum EntityType {
  USER
  WALLET
  VIN_PASSPORT
  DOCUMENT
  BlockchainTransaction
}


enum TxStatus {
  PENDING
  VERIFIED
  CONFIRMED
  FAILED
}

enum FileType {
  IMAGE
  PDF
  OTHER
}

enum FileState {
  UPLOADED
  PROCESSING
  VERIFIED
  REJECTED
}

enum ColorStatus {
  GREEN
  YELLOW
  LIGHT_ORANGE
  DARK_ORANGE
  RED
}

enum DocumentCategory {
  REGISTRATION
  INSURANCE
  OWNERSHIP
  OTHER
}

//////////////////////
// USER
//////////////////////

model User {
  id            String   @id @default(uuid())
  name          String?
  email         String?   
  password      String?
  role          UserRole?

  walletAddress String?   @unique
  signature     String?   // do NOT keep unique if this is login-based

  wallet        AztoWallet?
  auditLogs     AuditLog[]
  alerts        Alert[]
  documents     Document[]
  chainTxs      BlockchainTransaction[]

  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime?
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?
  isDeleted Boolean  @default(false)

  @@index([walletAddress])
  @@index([isDeleted])
}

//////////////////////
// WALLET 
//////////////////////

model AztoWallet {
  id      String  @id @default(uuid())
  balance Decimal @default(0) @db.Decimal(18, 8)

  userId  String  @unique
  user    User    @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime?
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?
  isDeleted Boolean  @default(false)
}

//////////////////////
// VIN PASSPORT
//////////////////////

model VinPassport {
  id             String @id @default(uuid())
  vin            String @unique
  extractedData  Json?
  vinMeta        Json?     // ⬅ Public VIN API response (optional)

  auditLogs      AuditLog[]
  documents      Document[]
  conditionMatrices   ConditionMatrix[]     

  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime?
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?
  isDeleted Boolean  @default(false)

  @@index([vin])
  @@index([isDeleted])
}

model ConditionMatrix {
  id            String @id @default(uuid())

  vinPassportId String
  vinPassport   VinPassport @relation(fields: [vinPassportId], references: [id])

  auditLogs     AuditLog[] @relation("ConditionMatrixAuditLogs")

  summary       Json      // ⬅ Verification output
  status        TxStatus  // VERIFIED / FAILED / PENDING

  flags         Json?     // mismatches, warnings
  isFinal       Boolean @default(false)

  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime?
  updatedBy String?
}

model BlockchainTransaction {
  id         String    @id @default(uuid())
  userId     String
  user       User      @relation(fields: [userId], references: [id])

  entityType EntityType
  entityId   String    // e.g., ConditionMatrix.id or VinPassport.id

  txHash     String
  status     TxStatus  @default(PENDING)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime?
}


model SystemState {
  id        String @id @default(uuid())
  key       String @unique
  value     String

  updatedAt DateTime @updatedAt
  updatedBy String?
}

model Document {
  id           String      @id @default(uuid())
  fileName     String
  fileUrl      String
  fileType     FileType
  state        FileState   @default(UPLOADED)
  checksum     String
  category     DocumentCategory

  vinPassportId String?    
  vinPassport   VinPassport? @relation(fields: [vinPassportId], references: [id])

  uploadedById String?     
  uploadedBy   User?        @relation(fields: [uploadedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime?
  deletedAt DateTime?
  isDeleted Boolean  @default(false)
  deletedBy String?

  auditLogs AuditLog[] @relation("DocumentAuditLogs") 

  @@index([vinPassportId])
  @@index([uploadedById])
}

//////////////////////
// AUDIT LOG
//////////////////////

model AuditLog {
  id         String      @id @default(uuid())
  action     AuditAction
  entityType EntityType
  entityId   String

  oldValue   Json?
  newValue   Json?

  userId        String?
  user          User?        @relation(fields: [userId], references: [id])

  vinPassportId String?
  vinPassport   VinPassport? @relation(fields: [vinPassportId], references: [id])

  documentId String?    // foreign key
  document   Document?  @relation("DocumentAuditLogs", fields: [documentId], references: [id])

  conditionMatrixId String?
  conditionMatrix   ConditionMatrix? @relation("ConditionMatrixAuditLogs", fields: [conditionMatrixId], references: [id])

  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime?
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?
  isDeleted Boolean  @default(false)

  @@index([entityType, entityId])
  @@index([userId])
}

//////////////////////
// ALERTS
//////////////////////

model Alert {
  id         String      @id @default(uuid())
  userName   String
  userRole   UserRole
  action     AlertAction
  activity   String
  businessId String?

  isRead     Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  deletedBy String?
  isDeleted Boolean  @default(false)

  userId     String?
  user       User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
}
